![cbuild](doc/logo.png)

[![build status](https://travis-ci.org/charto/cbuild.svg?branch=master)](http://travis-ci.org/charto/cbuild)
[![dependency status](https://david-dm.org/charto/cbuild.svg)](https://david-dm.org/charto/cbuild)
[![npm version](https://img.shields.io/npm/v/cbuild.svg)](https://www.npmjs.com/package/cbuild)

`cbuild` allows publishing leaner [SystemJS](https://github.com/systemjs/systemjs)-based apps and packages
running without build tools.
`npm` itself can pull all required frontend and backend dependencies.

Normally you would use `jspm` which also users of your package must install.
It's very powerful but has some drawbacks if plain `npm` is enough for your use case:

- `jspm` pulls another over 90 packages and 15 megabytes of code with it.
- ... downloads another separate copy of all required Node.js modules into a different directory structure.
- ... involves a large `config.js`, parts of which are manually edited (so belong to version control)
  and other parts autogenerated from `package.json` fields (so preferably omitted from version control).

`cbuild` instead uses Node.js module resolution to find packages installed using `npm` without additional configuration.
Only the manually edited parts are needed in `config.js`.

How does it work?
-----------------

`cbuild` simply passes your SystemJS `config.js` to [`systemjs-builder`](https://github.com/systemjs/builder),
which bundles your main JavaScript file with its dependencies.
`cbuild` adds a hook to look up any missing files using [`browser-resolve`](https://github.com/defunctzombie/node-browser-resolve).

That means you can still use `jspm` as before but you don't have to reinstall all your npm packages with it,
because `cbuild` also automatically looks inside `node_modules`.
Simple package deduplication is natively handled by `npm@3` or the `dedupe` command in `npm@2`.

For more complicated scenarios, the full power of SystemJS is still available for loading and bundling.

`cbuild` supports the `browser` field in `package.json`.
It can also generate a minimal `config.js` for SystemJS to load packages without having to bundle them.

Usage
-----

Add in the `scripts` section of your `package.json`:

```json
  "scripts": {
    "cbuild": "cbuild"
  }
```

Then run the commands:

```bash
npm install --save-dev cbuild
npm run cbuild -- -o bundle.js
```

This generates a new file `bundle.js` with all code required to load the file
defined in the `browser` (or `main` if `browser` is missing) field of `package.json`.
You can also set the file on the command line with the `--source` option.

Run `npm run cbuild -- --help` to see the command line options:

```
  Usage: cbuild [options]

  SystemJS node module bundling tool

  Options:

    -V, --version                output the version number
    -b, --builder-config <file>  specify SystemJS builder configuration file
    -d, --debug [flag]           use development environment
    -m, --map <package>          add package to mappings
    -s, --source <file>          main JavaScript source to bundle
    -p, --package <path>         directory with package.json and config.js
    -o, --out <file>             write output bundle to file
    -C, --out-config <file>      write path mappings to new config file
    -I, --include-config <file>  merge another file into new config file
    -q, --quiet [flag]           suppress terminal output
    -v, --verbose [flag]         print dependency tree of bundled files
    -x, --static [flag]          create static (sfx) bundle
    -h, --help                   output usage information
```

The `--builder-config` option accepts a JSON file containing
[SystemJS builder bundle options](https://github.com/systemjs/builder/blob/master/docs/api.md#bundle-options) and
[SystemJS configuration options](https://github.com/systemjs/systemjs/blob/master/docs/config-api.md#configuration-api)
structured like:

```JavaScript
{
	// Bundle options, for example:
	"minify": true,

	"config": {
		// Configuration options, for example:
		"buildCSS": false
	}
}
```

API
===
Docs generated using [`docts`](https://github.com/charto/docts)
>
> <a name="api-Branch"></a>
> ### Interface [`Branch`](#api-Branch)
> <em>Dependency tree branch, used for makeTree() output.</em>  
> Source code: [`<>`](http://github.com/charto/cbuild/blob/77b2a6f/src/cbuild.ts#L222-L225)  
>  
> Properties:  
> > **.0**<sub>?</sub> <sup><code>string</code></sup>  
> > &emsp;<em>File name.</em>  
>
> <a name="api-BuildItem"></a>
> ### Interface [`BuildItem`](#api-BuildItem)
> <em>systemjs-builder diagnostics for a single input file.</em>  
> Source code: [`<>`](http://github.com/charto/cbuild/blob/50a7bec/src/typings-custom.d.ts#L10-L27)  
>  
> Properties:  
> > **.name** <sup><code>string</code></sup>  
> > **.path** <sup><code>string</code></sup>  
> > **.metadata** <sup><code>{ [key: string]: any; }</code></sup>  
> > **.deps** <sup><code>string[]</code></sup>  
> > &emsp;<em>List of imports.</em>  
> > **.depMap** <sup><code>{ [name: string]: string; }</code></sup>  
> > &emsp;<em>Table mapping imports to their paths inside the bundle.</em>  
> > **.source** <sup><code>string</code></sup>  
> > **.fresh** <sup><code>boolean</code></sup>  
> > **.timestamp** <sup><code>number</code></sup>  
> > **.configHash** <sup><code>string</code></sup>  
> > **.runtimePlugin** <sup><code>boolean</code></sup>  
> > **.pluginConfig** <sup><code>any</code></sup>  
> > **.packageConfig** <sup><code>any</code></sup>  
> > **.isPackageConfig** <sup><code>any</code></sup>  
> > **.deferredImports** <sup><code>any</code></sup>  
>
> <a name="api-BuildOptions"></a>
> ### Interface [`BuildOptions`](#api-BuildOptions)
> <em>Options object for the build function.</em>  
> Source code: [`<>`](http://github.com/charto/cbuild/blob/77b2a6f/src/cbuild.ts#L13-L31)  
>  
> Properties:  
> > **.debug**<sub>?</sub> <sup><code>boolean</code></sup>  
> > &emsp;<em>If true, set NODE_ENV to development.</em>  
> > **.sfx**<sub>?</sub> <sup><code>boolean</code></sup>  
> > &emsp;<em>If true, create static (sfx) bundle.</em>  
> > **.bundlePath**<sub>?</sub> <sup><code>string</code></sup>  
> > &emsp;<em>Bundled file to output.</em>  
> > **.sourcePath**<sub>?</sub> <sup><code>string</code></sup>  
> > &emsp;<em>Main source file to bundle.</em>  
> > **.outConfigPath**<sub>?</sub> <sup><code>string</code></sup>  
> > &emsp;<em>Output config mapping other package names to their main source files.</em>  
> > **.mapPackages**<sub>?</sub> <sup><code>string[]</code></sup>  
> > &emsp;<em>Map additional packages in output config.</em>  
>
> <a name="api-BuildResult"></a>
> ### Interface [`BuildResult`](#api-BuildResult)
> <em>systemjs-builder diagnostics for the entire bundle.</em>  
> Source code: [`<>`](http://github.com/charto/cbuild/blob/50a7bec/src/typings-custom.d.ts#L31-L43)  
>  
> Properties:  
> > **.source** <sup><code>string</code></sup>  
> > &emsp;<em>Bundled output file contents.</em>  
> > **.sourceMap** <sup><code>string</code></sup>  
> > **.modules** <sup><code>string[]</code></sup>  
> > &emsp;<em>List of bundled files.</em>  
> > **.entryPoints** <sup><code>string[]</code></sup>  
> > &emsp;<em>List of files intended to be imported from the bundle(?).</em>  
> > **.tree** <sup><code>{ [path: string]: BuildItem; }</code></sup>  
> > **.assetList** <sup><code>any</code></sup>  
> > &emsp;<em>Other non-JavaScript files included in the bundle.</em>  
> > **.bundleName** <sup><code>string</code></sup>  
>
> <a name="api-build"></a>
> ### Function [`build`](#api-build)
> <em>Bundle files from package in basePath according to options.</em>  
> Source code: [`<>`](http://github.com/charto/cbuild/blob/77b2a6f/src/cbuild.ts#L98-L218)  
> > **build( )** <sup>&rArr; <code>Bluebird&lt;[BuildResult](#api-BuildResult)&gt;</code></sup> [`<>`](http://github.com/charto/cbuild/blob/77b2a6f/src/cbuild.ts#L98-L218)  
> > &emsp;&#x25aa; basePath <sup><code>string</code></sup>  
> > &emsp;&#x25ab; options<sub>?</sub> <sup><code>[BuildOptions](#api-BuildOptions)</code></sup>  
>
> <a name="api-makeTree"></a>
> ### Function [`makeTree`](#api-makeTree)
> <em>Extract a dependency tree from the build function result object.</em>  
> <em>Returns a nameless root item.</em>  
> <em>Each item is a list of a file name and its child items.</em>  
> <em>Uses Breadth-First Search to print shortest import chain to each file.</em>  
> Source code: [`<>`](http://github.com/charto/cbuild/blob/77b2a6f/src/cbuild.ts#L232-L279)  
> > **makeTree( )** <sup>&rArr; <code>[Branch](#api-Branch)</code></sup> [`<>`](http://github.com/charto/cbuild/blob/77b2a6f/src/cbuild.ts#L232-L279)  
> > &emsp;&#x25aa; result <sup><code>[BuildResult](#api-BuildResult)</code></sup>  

License
=======

[The MIT License](https://raw.githubusercontent.com/charto/cbuild/master/LICENSE)

Copyright (c) 2016 BusFaster Ltd
